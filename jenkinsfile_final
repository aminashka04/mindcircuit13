pipeline {
    agent any

    tools {
        maven 'maven3'
    }

    stages {
        stage('Checkout') {
            steps {
                echo 'Cloning GIT HUB Repo'
                // Clone the specified branch from the GitHub repository
                git branch: 'main', url: 'https://github.com/aminashka04/mindcircuit13.git'
            }
        }

        stage('SonarQube Scan') {
            steps {
                echo 'Scanning project'
                // List directory contents for debugging purposes
                sh 'ls -ltr'

                // Run SonarQube scan with specified SonarQube server and login token
                sh '''mvn sonar:sonar \\
                    -Dsonar.host.url=http://18.219.204.87:9000 \\
                    -Dsonar.login=squ_dee327edb446c1ab2d7c7b5dfd838e28161286e6'''
            }
        }

        stage('Build Artifact') {
            steps {
                echo 'Build Artifact'
                // Clean and package the project using Maven
                sh 'mvn clean package'
            }
        }

        stage('Build Docker Image') {
            steps {
                echo 'Docker Image Building'
                // Build the Docker image using the Dockerfile in the project
                // Tag the image with the current build number
                sh 'docker build -t aminashka96/batch13:${BUILD_NUMBER} .'
            }
        }

        stage('Push to Docker Hub') {
            steps {
                script {
                    // Use Docker Hub credentials securely with username and token
                    withCredentials([usernamePassword(credentialsId: 'aminashka96', usernameVariable: 'DOCKER_USER', passwordVariable: 'DOCKER_PASS')]) {
                        sh '''
                        echo "$DOCKER_PASS" | docker login -u "$DOCKER_USER" --password-stdin
                        docker push aminashka96/batch13:${BUILD_NUMBER}
                        '''
                    }
                    echo 'âœ… Pushed to Docker Hub'
                }
            }
        }

        stage('Update Deployment File') {
            environment {
                GIT_REPO_NAME = "mindcircuit13"
                GIT_USER_NAME = "aminashka04"
            }
            steps {
                echo 'Update Deployment File'
                withCredentials([string(credentialsId: 'githubtoken', variable: 'githubtoken')]) {
                    sh """
                    # Configure git user
                    git config user.email "aminashka04@gmail.com"
                    git config user.name "Ashka Amin"

                    # Replace the tag in the deployment YAML file with the current build number
                    sed -i 's/batch13:.*/batch13:${BUILD_NUMBER}/g' deploymentfiles/deployment.yml

                    # Stage all changes
                    git add .

                    # Commit changes with a message containing the build number
                    git commit -m "Update deployment image to version ${BUILD_NUMBER}" || echo "No changes to commit"

                    # Push changes to the main branch of the GitHub repository
                    git push https://${githubtoken}@github.com/${GIT_USER_NAME}/${GIT_REPO_NAME}.git HEAD:main
                    """
                }
            }
        }
    }
}
